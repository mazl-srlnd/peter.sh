<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Downloading Background Fetch content</title>
    <style>
      body { font-family: Arial; font-size: 12px; }
      li { margin-bottom: 2em; }
      h1 { font-size: 1.4em; margin: 0px; }
      h2 { font-size: 1em; margin: 0px; font-weight: normal; }
      span { color: red; font-style: italic; }

      textarea {
        width: 500px;
        height: 100px;
      }

      #start-fetch { margin-bottom: 1em; }

      fieldset {
        border: 1px solid #aaa;
        border-radius: 8px;
        padding: 1em;
        margin-bottom: 1em;
        font-size: 16px;
      }

      fieldset h1 {
        font-size: 1.2em;
        margin-bottom: 8px;
      }

      fieldset label {
        display: block;
      }
    </style>
  </head>
  <body>
    <fieldset>
      <h1>Options</h1>
      <label for="abort"><input type="checkbox" id="abort" checked /> Abort previous fetches</label>
      <label for="title"><input type="checkbox" id="title" checked /> Provide a proper title</label>
      <label for="download-total"><input type="checkbox" id="download-total" checked /> Provide a proper `<code>downloadTotal</code>`</label>
      <label for="delay"><input type="checkbox" id="delay" checked /> Delay the request by
        <select id="delay-seconds">
          <option>1</option>
          <option>5</option>
          <option>10</option>
          <option>30</option>
          <option>60</option>
          <option>120</option>
        </select> seconds</label>
    </fieldset>
    <input type="button" id="start-fetch" value="Start a background fetch..." disabled />
    <h1 id="result-name"></h1>
    <ol id="result-list"></ol>
    <script>
      var startButton = document.getElementById('start-fetch'),
          abort = document.getElementById('abort'),
          title = document.getElementById('title'),
          downloadTotal = document.getElementById('download-total'),
          delay = document.getElementById('delay'),
          delaySeconds = document.getElementById('delay-seconds');

      navigator.serviceWorker.register('background-fetch-content-sw.js', { scope: location.pathname })
        .then(registration => navigator.serviceWorker.ready)
        .then(registration => {
          startButton.addEventListener('click', () => {
            var id = 'my-fetch';
            var requests = [
              '/resources/icons/15.jpg',  // cat, 17644 bytes
              '/resources/random-cat-joke.php',  // text, 127 bytes through padding
              'https://static.peter.sh/images/play-blue.png',  // CORS not allowed, 1242 bytes
              'https://static.peter.sh/cors/1.png',  // CORS and allowed, 14093 bytes
            ];

            var options = {};
            var downloadTotal = 17644 /* 15.png */ + 127 /* cat joke */ + 1242 /* play-blue.png */ +
                                14093 /* 1.png */;

            if (title.checked)
              options.title = 'Aelurophile starter kit';

            if (delay.checked) {
              requests.push('/resources/slow-cat-icon-response.php?delay=' + delaySeconds.value);  // 17905 bytes
              downloadTotal += 17905;
            }

            if (downloadTotal.checked) {
              options.totalDownloadSize = downloadTotal; // <M62;
              options.downloadTotal = downloadTotal;
            }

            var promise = Promise.resolve();
            if (abort.checked) {
              var idFn = BackgroundFetchManager.prototype.hasOwnProperty('getIds') ? 'getIds' : 'getTags';
              promise = registration.backgroundFetch[idFn]()
                .then(ids => Promise.all(ids.map(id => registration.backgroundFetch.get(id))))
                .then(regs => Promise.all(regs.map(reg => reg.abort())));
            }

            promise.then(() => {
              registration.backgroundFetch.fetch(id, requests, options)
                .then(backgroundFetchRegistration => {
                  console.log('Registered the Background Fetch', backgroundFetchRegistration);
                });
              });
          });

          startButton.disabled = false;
        });

      var resultList = document.getElementById('result-list'),
          resultName = document.getElementById('result-name');

      navigator.serviceWorker.addEventListener('message', event => {
        resultList.innerHTML = '';  // clear previous results
        resultName.innerText = event.data.eventName;

        event.data.results.forEach(result => {
          var listItem = document.createElement('li'),
              resourceName = document.createElement('h1'),
              resourceStatus = document.createElement('h2'),
              resourceHeaders = document.createElement('pre');

          resourceName.textContent = result.url;
          resourceStatus.textContent =
              'Status: ' + result.status + ' ('  + result.statusText + '), ' +
              'ok: ' + (result.ok ? 'true' : 'false') + ', ' +
              'redirected: ' + (result.redirected ? 'true' : 'false') + ', ' +
              'type: ' + result.type;

          for (var key in result.headers)
            resourceHeaders.textContent += key + ': ' + result.headers[key] + '\n';

          listItem.appendChild(resourceName);
          listItem.appendChild(resourceStatus);
          listItem.appendChild(resourceHeaders);

          var resourceView = null;
          var isImage = result.url.endsWith('jpg') || result.url.endsWith('png') ||
                        (result.headers.hasOwnProperty('content-type') &&
                         result.headers['content-type'].startsWith('image'));

          if (!result.data) {
            resourceView = document.createElement('span');
            resourceView.textContent = 'No response data could be read.';

          } else if (isImage) {
            resourceView = document.createElement('img');
            resourceView.src = 'data:image/jpg;base64,' + result.data;

          } else {
            resourceView = document.createElement('textarea');
            resourceView.value = atob(result.data);
          }

          listItem.appendChild(resourceView);

          resultList.appendChild(listItem);
        });
      });
    </script>
  </body>
</html>
